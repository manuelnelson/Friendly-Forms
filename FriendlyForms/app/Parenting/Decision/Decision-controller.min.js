var DecisionCtrl=function(a,b,c,d,e,f,g,h){function i(b){var c=angular.copy(a.extraDecisions);d.extraDecisions.get({ChildId:b},function(e){_.each(e.ExtraDecisions,function(a){var b=_.find(c,function(b){return b.Description==a.Description});b&&(b.Id=a.Id,b.ChildId=a.ChildId,d.extraDecisions.update(null,b,function(){}),c=_.reject(c,function(b){return b.Description==a.Description}))}),_.each(c,function(a){a.ChildId=b,d.extraDecisions.save(null,a,function(){})}),d.decisions.get({ChildId:b},function(c){var e=angular.copy(a.decision);e.UserId=g.getFormUserId(),e.ChildId=b,typeof c.Id!="undefined"?(e.Id=c.Id,d.decisions.update(null,e,function(){a.showMessage=!0})):d.decisions.save(null,e,function(){a.showMessage=!0})})})}a.path=c.path(),a.showErrors=!1,a.showMessage=!1,a.showExtraErrors=!1,a.isLoaded=!1,d.children.get({UserId:b.userId},function(c){a.children=c.Children,a.childNdx=_.indexOf(_.pluck(a.children,"Id"),parseInt(b.childId)),a.childName=a.children[a.childNdx].Name,a.menuPath="/Parenting/Decision/user/"+b.userId+"/child/"+a.children[0].Id,e.isActive(a.menuPath)||e.setActive(a.menuPath)}),a.getChildDecision=function(b){a.decision=d.decisions.get({ChildId:b},function(){a.isLoaded=!0;if(typeof a.decision.Id=="undefined"||a.decision.Id==0)a.decision=$.jStorage.get(a.path)}),d.extraDecisions.get({ChildId:b},function(b){b.ExtraDecisions.length===0&&(a.extraDecisions=[]),a.extraDecisions=b.ExtraDecisions})},a.addExtraDecision=function(){if(a.addDecisionForm.$invalid){a.showExtraErrors=!0;return}a.showExtraErrors=!1,a.extraDecision.ChildId=a.children[a.childNdx].Id,a.extraDecision.UserId=g.getFormUserId(),d.extraDecisions.save(null,a.extraDecision,function(b){a.extraDecisions.push(b),a.extraDecision.DecisionMaker=-1,a.extraDecision.Description="",a.addDecisionForm.$setPristine()})},a.submit=function(b,c){if(a.decisionForm.$invalid){e.setSubMenuIconClass(a.menuPath,"icon-exclamation icon-red");var h=f.getFormInput("#decisionForm");$.jStorage.set(a.path,h),a.showErrors=!0;return}$.jStorage.deleteKey(a.path),a.decision.UserId=g.getFormUserId(),a.decision.ChildId=a.children[a.childNdx].Id,typeof a.decision.Id=="undefined"||a.decision.Id==0?d.decisions.save(null,a.decision,function(){}):d.decisions.update({Id:a.decision.Id},a.decision,function(){}),e.setSubMenuIconClass(a.menuPath,"icon-ok icon-green");if(a.extraDecisions.length>0){var i=0;_.each(a.extraDecisions,function(b){d.extraDecisions.update(null,b,function(){i++,a.extraDecisions.length===i&&c&&c()})})}else c&&c()},a.previousChild=function(){a.submit(!1,function(){a.childNdx=_.indexOf(_.pluck(a.children,"Id"),parseInt(b.childId));if(a.childNdx===0){e.previousMenu();return}a.childNdx=a.childNdx-1;var d=a.children[a.childNdx].Id;c.path("/Parenting/Decision/user/"+b.userId+"/child/"+d)})},a.nextChild=function(){a.submit(!1,function(){a.childNdx=_.indexOf(_.pluck(a.children,"Id"),parseInt(b.childId));if(a.childNdx===a.children.length-1){e.nextMenu();return}a.childNdx=a.childNdx+1;var d=a.children[a.childNdx].Id;e.setSubMenuIconClass(a.path,"icon-ok icon-green"),c.path("/Parenting/Decision/user/"+b.userId+"/child/"+d)})},a.copyChild=function(c){a.submit(!1,function(){c===0?_.each(a.children,function(a){a.childId!=b.childId&&i(a.Id)}):i(c)})},a.getChildDecision(b.childId),f.refreshPage(function(){h.currentScope=a})};DecisionCtrl.$inject=["$scope","$routeParams","$location","decisionService","menuService","genericService","userService","$rootScope"]